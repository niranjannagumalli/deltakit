---
name: Build, test, and publish stable wheels on PyPI
permissions:
  contents: read

on:
  workflow_dispatch:
    inputs:
      gh_release:
        description: 'Create a GitHub release'
        required: false
        default: false
        type: boolean
      run_tests:
        description: 'Run tests'
        required: false
        default: false
        type: boolean
      publish_to_pypi:
        description: 'Publish to PyPI'
        required: false
        default: false
        type: boolean

jobs:

  #Â Build all deltakit wheels and sdists.
  build_dists:
    runs-on: ubuntu-slim
    steps:
      - name: Checking out the deltakit repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Build all deltakit packages wheels and sdists
        run: uv build --no-sources --all-packages

      - name: Upload all deltakit packages wheels and sdists
        uses: actions/upload-artifact@v4
        with:
          name: all-deltakit-dists
          path: ./dist/*
          # No need to keep these as they will be published in this workflow.
          retention-days: 1

  # To avoid creating unnecessary CI jobs, and because most packages are
  # typically installed through `pip install deltakit`, this job does not test each deltakit
  # package in isolation. Instead, it installs all of them and performs all tests suites in
  # a single environment.
  test_wheels:
    if: ${{ inputs.run_tests }}
    name: >-
      Test wheels on ${{ matrix.os }}
      (Python ${{ matrix.python-version }} '${{ matrix.dependency-resolution }}')
    needs: build_dists
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: ['ubuntu-latest', 'windows-latest', 'macos-latest']
        python-version: ['3.10', '3.11', '3.12', '3.13']
        dependency-resolution: ['highest', 'lowest-direct']
        exclude:
          # No pre-built wheels for stim
          - os: 'windows-latest'
            python-version: '3.13'
    steps:
      - name: Checking out the deltakit repository
        uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Download dists
        uses: actions/download-artifact@v4
        with:
          name: all-deltakit-dists
          path: ./dist

      - name: Setup venv (UNIX)
        if: matrix.os != 'windows-latest'
        run: |
          uv sync --all-packages --python ${{ matrix.python-version }} --resolution ${{matrix.dependency-resolution}} --group test --find-links ./dist/
          uv pip install ./dist/deltakit*.whl
          uv run --python ${{ matrix.python-version }} --no-sync pytest ./ ./deltakit-*

      - name: Setup venv + tests (Windows)
        if: matrix.os == 'windows-latest'
        run: |
          uv sync --all-packages --python ${{ matrix.python-version }} --resolution ${{matrix.dependency-resolution}} --group test --find-links ./dist/
          cd dist
          uv pip install (Get-ChildItem deltakit*.whl).FullName
          cd ..
          uv run --python ${{ matrix.python-version }} --no-sync pytest . (Get-ChildItem deltakit-*).FullName


  test_sdists:
    if: ${{ inputs.run_tests }}
    name: Test sdists correctly imports
    needs: build_dists
    runs-on: ubuntu-slim
    steps:
      - uses: actions/checkout@v6

      - name: Install uv
        uses: astral-sh/setup-uv@v7

      - name: Download dists
        uses: actions/download-artifact@v4
        with:
          name: all-deltakit-dists
          path: ./dist

      - name: Try to install the sdists
        run: |
          uv venv --clear
          uv pip install ./dist/deltakit*.tar.gz

  publish:
    if: ${{ inputs.publish_to_pypi }}
    name: Publish Python distribution to PyPI
    needs: [test_wheels, test_sdists]
    runs-on: ubuntu-slim
    environment:
      name: pypi
      url: https://pypi.org/p/${{ matrix.project }}
    permissions:
      id-token: write  # IMPORTANT: mandatory for trusted publishing
    steps:
      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: all-deltakit-dists
          path: ./dist
      - name: Publish distribution to PyPI
        uses: pypa/gh-action-pypi-publish@release/v1

  github-release:
    if: ${{ inputs.gh_release }}
    name: Sign the Python distribution with Sigstore and upload them to GitHub Release
    needs: [publish]
    runs-on: ubuntu-slim
    permissions:
      contents: write  # IMPORTANT: mandatory for making GitHub Releases
      id-token: write  # IMPORTANT: mandatory for sigstore
    steps:
      - uses: actions/checkout@v4

      - name: Download all the dists
        uses: actions/download-artifact@v4
        with:
          name: all-deltakit-dists
          path: ./dist

      - name: Sign the dists with Sigstore
        uses: sigstore/gh-action-sigstore-python@v3.0.1
        with:
          inputs: ./dist/*.tar.gz ./dist/*.whl

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
            python-version: '3.10'

      - name: Extract latest version notes
        run: python tools/extract_version_notes.py GH_RELEASE_NOTES.md

      - name: Create GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        run: >-
          gh release create
          '${{ github.ref_name }}'
          --repo '${{ github.repository }}'
          --notes-file GH_RELEASE_NOTES.md

      - name: Package sdists/signatures together
        run: |
          cd dist
          zip sdists.zip *.tar.gz
          zip signatures.zip *.json
          rm -f *.tar.gz *.json
      - name: Upload artefact signatures to GitHub Release
        env:
          GITHUB_TOKEN: ${{ github.token }}
        # Upload to GitHub Release using the `gh` CLI.
        # `dist/` contains the built packages, and the
        # sigstore-produced signatures and certificates.
        run: >-
          gh release upload
          '${{ github.ref_name }}' dist/**
          --repo '${{ github.repository }}'
